<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Chess Flashcards</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      text-align: center;
    }

    /* ==========================
       GLOBAL BUTTON STYLE
    =========================== */
    button,
    select,
    input[type="file"] {
      padding: 10px 24px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(180deg, #ffffff 0%, #e6e6e6 100%);
      cursor: pointer;
      font-size: 0.95em;
      font-weight: 600;
      transition: 0.2s;
      border: 1px solid #ccc;
    }

    button:hover,
    select:hover,
    input[type="file"]:hover {
      background: linear-gradient(180deg, #fdfdfd 0%, #dcdcdc 100%);
      transform: translateY(-1px);
    }

    .dark-mode button,
    .dark-mode select,
    .dark-mode input[type="file"] {
      background: #2b2b2b;
      border: 1px solid #555;
      color: #eee;
    }

    /* TOP BUTTONS CENTER */
    #top-center-buttons {
      display: flex;
      justify-content: center;
      gap: 14px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    #topBar {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    /* FLASHCARD CARD */
    #card {
      text-align: center;
      border: 1px solid #ddd;
      padding: 18px;
      border-radius: 6px;
      max-width: 500px;
      margin: 0 auto;
    }

    #boardImg {
      width: 100%;
      max-width: 420px;
      margin-top: 10px;
      border: 1px solid #ccc;
    }

    #controls {
      margin-top: 15px;
    }

    #controls>div {
      display: flex;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    #favoriteIndicator {
      font-size: 1.4em;
      margin-left: 5px;
      color: #999;
    }

    #favoriteIndicator.active {
      color: gold;
    }

    /* DARK MODE */
    .dark-mode {
      background: #141414;
      color: #eee;
    }

    .dark-mode #card {
      border-color: #444;
    }

    .dark-mode #boardImg {
      border-color: #555;
    }

    .dark-mode #favoriteIndicator {
      color: #667;
    }

    .dark-mode #favoriteIndicator.active {
      color: gold;
    }

    /* MOBILE LAYOUT */
    @media(max-width:600px) {

      button,
      select,
      input[type="file"] {
        width: 90%;
        max-width: 260px;
        padding: 10px 12px;
        font-size: 0.85em;
      }

      #top-center-buttons {
        flex-direction: column;
        align-items: center;
        width: 100%;
      }

      #topBar {
        flex-direction: column;
        width: 100%;
        align-items: center;
      }

      #controls>div {
        flex-direction: column;
        width: 100%;
        align-items: center;
      }

      #bottom-file input[type="file"] {
        width: 90%;
      }
    }

    select,
    option {
      text-align: center;
      text-align-last: center;
    }
  </style>

</head>


<body>

  <h1>Chess Flashcards</h1>

  <nav class="header-links" style="text-align:center;">
    <a href="https://chessmnemonics.net/index.html">Chess Mnemonic Application and Epic Chess Stories Creator</a><br><br>
    <a href="https://chessmnemonics.net/flashcards/">Libraries Flashcards Trainer</a><br><br>
  </nav>

  <div id="statusMsg" style="text-align:center; font-weight:700; margin-bottom:12px; color:green;"></div>

  <div style="text-align:center; font-size:0.9em; margin-bottom:15px;">
    <img src="/data/Sharpen cover.png"
      style="width:55%; max-width:230px; display:block; margin:0 auto 8px;">
    Source of 15 default tactical positions: <em>Sharpen Your Tactics!</em><br>
    by Grandmasters Anatoly Lein & Boris Archangelsky
  </div>

  <!-- TOP BUTTONS -->
  <div id="top-center-buttons">
    <button id="openFenBuilderBtn">Use lichess.org FEN Builder</button>

    <select id="themeSelect">
      <option value="light">Light background</option>
      <option value="dark">Dark background</option>
    </select>
  </div>

  <!-- MODE / DIFFICULTY -->
  <div id="topBar">
    <button id="modeBtn">Mode: Random</button>
    <button id="jumpBtn">Go to number #</button>

    <select id="rangeSelect">
      <option value="">Choose Difficulty</option>
      <option value="1-10,12-14">***</option>
      <option value="11,15">****</option>
    </select>
  </div>

  <!-- FLASHCARD -->
  <div id="card">

    <div id="problemCounter"
      style="margin-bottom:8px; font-weight:700; font-size:1.1em; color:#0a7c24;"></div>

    <img id="boardImg">

    <div id="controls">

      <div>
        <button id="previous-btn">← Previous</button>
        <button id="next-btn">Next →</button>
        <button id="favorite-btn">★ Favorite</button>
        <span id="favoriteIndicator">☆</span>
      </div>

      <div id="bottom-file">
        <input type="file" id="upload" multiple accept="image/*">
        <div>(Upload only images and screenshots)</div>
        <div style="font-size:0.8em; font-weight:700; color:green; margin-top:4px;">
          The images you upload are temporary. They are lost on refresh.<br>
          Once you click the refresh button, the default (15) images are loaded again.
        </div>
      </div>

    </div>

  </div>


<script>
/* ===============================
   ALWAYS LOAD 15 DEFAULTS
================================ */
let TOTAL = 15;

const statusMsg = document.getElementById("statusMsg");
statusMsg.textContent = "Default 15 images were loaded...";
statusMsg.style.color = "green";

const cards = [];
for (let i = 1; i <= TOTAL; i++) {
  cards.push({
    id: i,
    image: `problems/problem_${i}.png`,
    favorite: false
  });
}

const boardImg = document.getElementById("boardImg");
const favoriteIndicator = document.getElementById("favoriteIndicator");
const modeBtn = document.getElementById("modeBtn");
const uploadInput = document.getElementById("upload");

/* === THEME SELECT ELEMENT === */
const themeSelect = document.getElementById("themeSelect");

/* =============================
   AUTO-DETECT SYSTEM THEME
============================= */
if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
  document.body.classList.add("dark-mode");
  themeSelect.value = "dark";
} else {
  themeSelect.value = "light";
}

/* USER MANUAL THEME CHANGE */
themeSelect.onchange = () => {
  if (themeSelect.value === "dark") {
    document.body.classList.add("dark-mode");
  } else {
    document.body.classList.remove("dark-mode");
  }
};

let currentIndex = 0;
let mode = "random";

function updateModeButton() {
  modeBtn.textContent = (mode === "random") ? "Mode: Random" : "Mode: Sequential";
}

function showCard(i) {
  const c = cards[i];
  boardImg.src = c.image;
  document.getElementById("problemCounter").textContent =
    "Problem " + (i + 1) + " of " + cards.length;
  favoriteIndicator.textContent = c.favorite ? "★" : "☆";
  favoriteIndicator.classList.toggle("active", c.favorite);
}

updateModeButton();
showCard(currentIndex);

/* NAVIGATION */
modeBtn.onclick = () => {
  mode = (mode === "random") ? "sequential" : "random";
  updateModeButton();
};

function getRandomDifferentIndex() {
  if (cards.length <= 1) return currentIndex;
  let newIndex = currentIndex;
  while (newIndex === currentIndex) {
    newIndex = Math.floor(Math.random() * cards.length);
  }
  return newIndex;
}

document.getElementById("next-btn").onclick = () => {
  currentIndex = (mode === "random")
    ? getRandomDifferentIndex()
    : (currentIndex + 1) % cards.length;
  showCard(currentIndex);
};

document.getElementById("previous-btn").onclick = () => {
  currentIndex = (mode === "random")
    ? getRandomDifferentIndex()
    : (currentIndex - 1 + cards.length) % cards.length;
  showCard(currentIndex);
};

document.getElementById("favorite-btn").onclick = () => {
  cards[currentIndex].favorite = !cards[currentIndex].favorite;
  showCard(currentIndex);
};

document.getElementById("jumpBtn").onclick = () => {
  const v = parseInt(prompt("Enter number (1-" + cards.length + ")"));
  if (v >= 1 && v <= cards.length) {
    currentIndex = v - 1;
    showCard(currentIndex);
  }
};

document.getElementById("rangeSelect").onchange = e => {
  const v = e.target.value;
  if (!v) return;
  const arr = [];
  v.split(",").forEach(s => {
    if (s.includes("-")) {
      let [a, b] = s.split("-").map(Number);
      for (let x = a; x <= b; x++) arr.push(x);
    } else arr.push(Number(s));
  });
  currentIndex = arr[Math.floor(Math.random() * arr.length)] - 1;
  showCard(currentIndex);
};

document.getElementById("openFenBuilderBtn").onclick = () => {
  window.open("https://lichess.org/editor", "_blank");
};

/* =============================
   UPLOAD HANDLER – OPTION A
   Prompt → Immediately open dialog
============================= */

// Απαραίτητο flag για να μην ανοίγει διπλά
let skipPromptOnce = false;

// 1) Μόλις πατήσει το κουμπί Upload → prompt ΠΡΙΝ ανοίξει το dialog
uploadInput.addEventListener("click", (e) => {

  if (skipPromptOnce) {
    // αυτό το click είναι τεχνικό (από την JS)
    skipPromptOnce = false;
    return;
  }

  let userTotal = parseInt(prompt(
    "How many images are in your folder? Please name your folder 'problems' and the images problem_16, problem_17, etc ...\nTo use the default just write 15."
  ));

  if (Number.isFinite(userTotal) && userTotal > 15) {
    for (let i = 16; i <= userTotal; i++) {
      cards.push({
        id: cards.length + 1,
        image: `problems/problem_${i}.png`,
        favorite: false
      });
    }

    statusMsg.style.color = "green";
    statusMsg.textContent =
      `Loaded ${userTotal} images (default 15 + ${userTotal - 15} extra).`;
  }

  // ΜΗΝ ανοίξεις τώρα το dialog - θα το ανοίξουμε σε microtask
  e.preventDefault();

  // Open file dialog IMMEDIATELY after prompt, without re-triggering prompt
  Promise.resolve().then(() => {
    skipPromptOnce = true;
    uploadInput.click();
  });
});

// 2) Μετά την επιλογή αρχείων → φόρτωσε τις uploaded
uploadInput.addEventListener("change", (event) => {

  const files = Array.from(event.target.files || []).filter(f =>
    f.type.startsWith("image/")
  );

  if (!files.length) {
    statusMsg.textContent = "No image files selected.";
    statusMsg.style.color = "red";
    return;
  }

  files.forEach(file => {
    const url = URL.createObjectURL(file);
    cards.push({
      id: cards.length + 1,
      image: url,
      favorite: false
    });
  });

  statusMsg.style.color = "green";
  statusMsg.textContent =
    files.length === 1
      ? "1 uploaded image added after the default problems."
      : files.length + " uploaded images added after the default problems.";

  currentIndex = cards.length - files.length;
  showCard(currentIndex);
});
</script>

</body>
</html>
